namespace :cicd_security do
  desc "Disable authentication for CI/CD environments"
  task disable: :environment do
    cicd_security_file = Rails.root.join("config", "initializers", "cicd_security.rb")

    # Create the initializer file with CiCdSecurityDisable = true
    File.write(cicd_security_file, <<~RUBY)
      # This file is auto-generated by rake task cicd_security:disable
      # It disables authentication for CI/CD environments
      # To re-enable authentication, run: rake cicd_security:enable

      CiCdSecurityDisable = true
    RUBY

    puts "âœ… Authentication disabled for CI/CD environment"
    puts "ðŸ“ Created: #{cicd_security_file}"
    puts "ðŸ”’ Users will not be required to authenticate"
    puts ""
    puts "To re-enable authentication, run: rake cicd_security:enable"
  end

  desc "Enable authentication (remove CI/CD security bypass)"
  task enable: :environment do
    cicd_security_file = Rails.root.join("config", "initializers", "cicd_security.rb")

    if File.exist?(cicd_security_file)
      File.delete(cicd_security_file)
      puts "âœ… Authentication re-enabled"
      puts "ðŸ—‘ï¸  Removed: #{cicd_security_file}"
      puts "ðŸ” Users will now be required to authenticate"
    else
      puts "â„¹ï¸  Authentication is already enabled"
      puts "ðŸ“ No security bypass file found at: #{cicd_security_file}"
    end
  end

  desc "Check current CI/CD security status"
  task status: :environment do
    cicd_security_file = Rails.root.join("config", "initializers", "cicd_security.rb")

    if File.exist?(cicd_security_file)
      puts "ðŸ”´ CI/CD Security: DISABLED"
      puts "ðŸ“ File exists: #{cicd_security_file}"
      puts "ðŸ”’ Users are NOT required to authenticate"
      puts ""
      puts "To enable authentication, run: rake cicd_security:enable"
    else
      puts "ðŸŸ¢ CI/CD Security: ENABLED"
      puts "ðŸ“ No bypass file found"
      puts "ðŸ” Users ARE required to authenticate"
      puts ""
      puts "To disable authentication, run: rake cicd_security:disable"
    end
  end
end
