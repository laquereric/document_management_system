<% content_for :title, "Activity Logs" %>

<div class="container-lg px-3">
  <!-- Page Header -->
  <div class="d-flex flex-items-center flex-justify-between py-4 border-bottom">
    <div class="d-flex flex-items-center">
      <svg class="octicon octicon-pulse mr-2 color-fg-accent" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="24" height="24">
        <path d="M6 2c.306 0 .582.187.696.471L10 10.731l1.304-3.26A.751.751 0 0 1 12 7h3.25a.75.75 0 0 1 0 1.5H12.58l-1.855 4.64a.751.751 0 0 1-1.393-.011L6 5.069 4.696 8.329A.751.751 0 0 1 4 8.5H.75a.75.75 0 0 1 0-1.5h2.68l1.85-4.629A.751.751 0 0 1 6 2Z"></path>
      </svg>
      <div>
        <h1 class="f2 lh-condensed text-semibold mb-1">Activity Logs</h1>
        <p class="f5 color-fg-muted mb-0">Track and monitor system activity and document changes</p>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="mt-4">
    <h2 class="f4 text-semibold mb-3">Activity Overview</h2>
    <div class="d-flex flex-wrap" style="gap: 16px;">
      <div class="flex-1" style="min-width: 240px;">
        <div class="Box p-3">
          <div class="d-flex flex-items-center">
            <div class="mr-3">
              <svg class="octicon octicon-pulse color-fg-accent" width="24" height="24" viewBox="0 0 16 16">
                <path d="M6 2c.306 0 .582.187.696.471L10 10.731l1.304-3.26A.751.751 0 0 1 12 7h3.25a.75.75 0 0 1 0 1.5H12.58l-1.855 4.64a.751.751 0 0 1-1.393-.011L6 5.069 4.696 8.329A.751.751 0 0 1 4 8.5H.75a.75.75 0 0 1 0-1.5h2.68l1.85-4.629A.751.751 0 0 1 6 2Z"></path>
              </svg>
            </div>
            <div>
              <div class="f1 lh-condensed text-semibold">
                <% if @activity_logs.respond_to?(:total_count) %>
                  <%= @activity_logs.total_count %>
                <% else %>
                  <%= @activity_logs.count %>
                <% end %>
              </div>
              <div class="f6 color-fg-muted">Total Activities</div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex-1" style="min-width: 240px;">
        <div class="Box p-3">
          <div class="d-flex flex-items-center">
            <div class="mr-3">
              <svg class="octicon octicon-calendar color-fg-success" width="24" height="24" viewBox="0 0 16 16">
                <path d="M4.75 0a.75.75 0 0 1 .75.75V2h5V.75a.75.75 0 0 1 1.5 0V2h1.25c.966 0 1.75.784 1.75 1.75v11.5A1.75 1.75 0 0 1 13.25 17H2.75A1.75 1.75 0 0 1 1 15.25V3.75C1 2.784 1.784 2 2.75 2H4V.75A.75.75 0 0 1 4.75 0Zm0 3.5h8.5a.25.25 0 0 1 .25.25V6h-11V3.75a.25.25 0 0 1 .25-.25H2.5v.75a.75.75 0 0 0 1.5 0V3.5Zm-2 4.25h11v7.5a.25.25 0 0 1-.25.25H2.75a.25.25 0 0 1-.25-.25v-7.5Z"></path>
              </svg>
            </div>
            <div>
              <div class="f1 lh-condensed text-semibold">
                <%= ActivityLog.where('created_at >= ?', 24.hours.ago).count %>
              </div>
              <div class="f6 color-fg-muted">Last 24 Hours</div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex-1" style="min-width: 240px;">
        <div class="Box p-3">
          <div class="d-flex flex-items-center">
            <div class="mr-3">
              <svg class="octicon octicon-person color-fg-attention" width="24" height="24" viewBox="0 0 16 16">
                <path d="M10.561 8.073a6.005 6.005 0 0 1 3.432 5.142.75.75 0 1 1-1.498.07 4.5 4.5 0 0 0-8.99 0 .75.75 0 0 1-1.498-.07 6.004 6.004 0 0 1 3.431-5.142 3.999 3.999 0 1 1 5.123 0ZM10.5 5a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
              </svg>
            </div>
            <div>
              <div class="f1 lh-condensed text-semibold">
                <%= ActivityLog.joins(:user).distinct.count('activity_logs.user_id') %>
              </div>
              <div class="f6 color-fg-muted">Active Users</div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex-1" style="min-width: 240px;">
        <div class="Box p-3">
          <div class="d-flex flex-items-center">
            <div class="mr-3">
              <svg class="octicon octicon-arrow-switch color-fg-done" width="24" height="24" viewBox="0 0 16 16">
                <path d="M5.22 14.78a.75.75 0 0 1-1.06 0L.47 11.03a.75.75 0 0 1 0-1.06l3.75-3.75a.75.75 0 0 1 1.06 1.06L2.81 10.5H14.5a.75.75 0 0 1 0 1.5H2.81l2.47 2.47a.75.75 0 0 1 0 1.06Zm5.56-9.5a.75.75 0 0 1 1.06 0l3.75 3.75a.75.75 0 0 1 0 1.06l-3.75 3.75a.75.75 0 1 1-1.06-1.06l2.47-2.47H1.5a.75.75 0 0 1 0-1.5h11.69l-2.47-2.47a.75.75 0 0 1 0-1.06Z"></path>
              </svg>
            </div>
            <div>
              <div class="f1 lh-condensed text-semibold">
                <%= ActivityLog.where(action: 'status_change').count %>
              </div>
              <div class="f6 color-fg-muted">Status Changes</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="mt-5">
    <h2 class="f4 text-semibold mb-3">Search & Filters</h2>
    <div class="Box">
      <div class="Box-body">
        <%= search_form_for @q, url: activity_logs_path, method: :get, class: "d-flex flex-items-center gap-3" do |f| %>
          <div class="flex-1">
            <%= f.label :action_cont, "Action", class: "form-label sr-only" %>
            <%= f.text_field :action_cont, class: "form-control", placeholder: "Search by action..." %>
          </div>
          <div class="flex-1">
            <%= f.label :document_title_cont, "Document", class: "form-label sr-only" %>
            <%= f.text_field :document_title_cont, class: "form-control", placeholder: "Filter by document..." %>
          </div>
          <div class="flex-1">
            <%= f.label :user_name_cont, "User", class: "form-label sr-only" %>
            <%= f.text_field :user_name_cont, class: "form-control", placeholder: "Filter by user..." %>
          </div>
          <div>
            <%= f.submit "Search", class: "btn btn-primary" %>
          </div>
          <div>
            <%= link_to "Clear", activity_logs_path, class: "btn" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Activity Logs Section -->
  <div class="mt-5">
    <div class="d-flex flex-items-center flex-justify-between mb-3">
      <h2 class="f4 text-semibold">
        Recent Activity
        <% if @activity_logs.respond_to?(:total_count) %>
          <span class="Counter"><%= @activity_logs.total_count %></span>
        <% else %>
          <span class="Counter"><%= @activity_logs.count %></span>
        <% end %>
      </h2>
    </div>

    <div class="Box">
      <div class="Box-body">
        <% if @activity_logs.any? %>
          <div class="Timeline">
            <% @activity_logs.each do |activity_log| %>
              <div class="TimelineItem">
                <div class="TimelineItem-badge">
                  <% case activity_log.action %>
                  <% when 'created' %>
                    <svg class="octicon octicon-plus color-fg-success" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                      <path d="M8 2a.75.75 0 0 1 .75.75v4.5h4.5a.75.75 0 0 1 0 1.5h-4.5v4.5a.75.75 0 0 1-1.5 0v-4.5h-4.5a.75.75 0 0 1 0-1.5h4.5v-4.5A.75.75 0 0 1 8 2Z"></path>
                    </svg>
                  <% when 'updated' %>
                    <svg class="octicon octicon-pencil color-fg-accent" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                      <path d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-.897.897a.75.75 0 0 1-.53.22H13.25a.75.75 0 0 1-.75-.75v-1.5a.75.75 0 0 0-.75-.75h-1.5a.75.75 0 0 0-.75.75v1.5a.75.75 0 0 1-.75.75H9.5a.75.75 0 0 1-.53-.22l-.897-.897a1.75 1.75 0 0 1 0-2.474l1.086-1.086Z"></path>
                    </svg>
                  <% when 'status_change' %>
                    <svg class="octicon octicon-arrow-switch color-fg-attention" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                      <path d="M5.22 14.78a.75.75 0 0 1-1.06 0L.47 11.03a.75.75 0 0 1 0-1.06l3.75-3.75a.75.75 0 0 1 1.06 1.06L2.81 10.5H14.5a.75.75 0 0 1 0 1.5H2.81l2.47 2.47a.75.75 0 0 1 0 1.06Zm5.56-9.5a.75.75 0 0 1 1.06 0l3.75 3.75a.75.75 0 0 1 0 1.06l-3.75 3.75a.75.75 0 1 1-1.06-1.06l2.47-2.47H1.5a.75.75 0 0 1 0-1.5h11.69l-2.47-2.47a.75.75 0 0 1 0-1.06Z"></path>
                    </svg>
                  <% when 'deleted' %>
                    <svg class="octicon octicon-trash color-fg-danger" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                      <path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.748 1.748 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z"></path>
                    </svg>
                  <% else %>
                    <svg class="octicon octicon-dot color-fg-muted" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                      <path d="M8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8Z"></path>
                    </svg>
                  <% end %>
                </div>
                
                <div class="TimelineItem-body">
                  <div class="d-flex flex-items-center justify-content-between">
                    <div class="flex-1">
                      <div class="d-flex flex-items-center gap-2 mb-1">
                        <span class="text-bold">
                          <%= activity_log.user&.name || "Unknown User" %>
                        </span>
                        <span class="color-fg-muted">
                          <%= activity_log.action.humanize.downcase %>
                        </span>
                        <% if activity_log.action == 'status_change' && activity_log.old_status && activity_log.new_status %>
                          <span class="color-fg-muted">from</span>
                          <span class="Label Label--secondary"><%= activity_log.old_status.name %></span>
                          <span class="color-fg-muted">to</span>
                          <span class="Label Label--accent"><%= activity_log.new_status.name %></span>
                        <% end %>
                      </div>
                      
                      <% if activity_log.document %>
                        <div class="d-flex flex-items-center gap-2 mb-1">
                          <svg class="octicon octicon-file-text color-fg-muted" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                            <path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6H9.75A1.75 1.75 0 0 1 8 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path>
                          </svg>
                          <%= link_to activity_log.document.title, document_path(activity_log.document), class: "Link--primary" %>
                        </div>
                      <% end %>
                      
                      <% if activity_log.notes.present? %>
                        <div class="color-fg-muted f6 mt-1">
                          <%= activity_log.notes %>
                        </div>
                      <% end %>
                    </div>
                    
                    <div class="f6 color-fg-muted">
                      <%= time_ago_in_words(activity_log.created_at) %> ago
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

          <!-- Pagination -->
          <% if @activity_logs.respond_to?(:current_page) %>
            <div class="d-flex flex-justify-center mt-4">
              <nav class="paginate-container" aria-label="Pagination">
                <div class="pagination">
                  <% if @activity_logs.prev_page %>
                    <%= link_to "Previous", url_for(page: @activity_logs.prev_page), class: "previous_page", rel: "prev" %>
                  <% else %>
                    <span class="previous_page disabled">Previous</span>
                  <% end %>
                  
                  <% @activity_logs.total_pages.times do |page_num| %>
                    <% page_num += 1 %>
                    <% if page_num == @activity_logs.current_page %>
                      <em class="current"><%= page_num %></em>
                    <% elsif page_num == 1 || page_num == @activity_logs.total_pages || (page_num >= @activity_logs.current_page - 2 && page_num <= @activity_logs.current_page + 2) %>
                      <%= link_to page_num, url_for(page: page_num) %>
                    <% elsif page_num == @activity_logs.current_page - 3 || page_num == @activity_logs.current_page + 3 %>
                      <span class="gap">…</span>
                    <% end %>
                  <% end %>
                  
                  <% if @activity_logs.next_page %>
                    <%= link_to "Next", url_for(page: @activity_logs.next_page), class: "next_page", rel: "next" %>
                  <% else %>
                    <span class="next_page disabled">Next</span>
                  <% end %>
                </div>
              </nav>
            </div>
          <% end %>
        <% else %>
          <%= render(Ui::EmptyStateComponent.new(
            title: "No Activity Found",
            description: params[:q]&.values&.any?(&:present?) ? 
              "Try adjusting your search criteria" : 
              "Activity will appear here as users interact with documents",
            icon: "pulse"
          )) %>
        <% end %>
      </div>
    </div>
  </div>
</div>
