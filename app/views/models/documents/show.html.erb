<% content_for :title, @document.title %>

<%= render Layout::Page::PageContent.new(padding: :none) do %>
  <!-- Page Header -->
  <%= render Layout::Page::PageHeader.new(
    title: @document.title,
    description: "Document in #{@document.folder&.name || 'workspace'}",
    icon: "file-text",
    breadcrumb_items: [
      { text: "Documents", url: models_documents_path },
      { text: @document.folder&.name || "Unknown", url: @document.folder ? models_folder_path(@document.folder) : "#" },
      { text: @document.title, url: "#" }
    ]
  ) do %>
    <div class="d-flex gap-2">
      <%= render Ui::StatusBadgeComponent.new(status: @document.status) if @document.status %>
      <%= render Primer::Beta::Button.new(
        tag: :a, 
        href: models_edit_document_path(@document),
        variant: :primary,
        size: :small
      ) do %>
        <%= render Primer::Beta::Octicon.new(icon: "pencil", size: :small, classes: "mr-1") %>
        Edit
      <% end %>
    </div>
  <% end %>

  <!-- Main Content -->
  <div class="Layout Layout--flowRow-until-md Layout--sidebarPosition-start">
    <!-- Main Column -->
    <div class="Layout-main">
      <!-- Document Content -->
      <div class="Box mb-4">
        <div class="Box-header">
          <h3 class="Box-title">Content</h3>
        </div>
        <div class="Box-body">
          <% if @document.content.present? %>
            <div class="markdown-body">
              <%= simple_format(@document.content, {}, wrapper_tag: "div") %>
            </div>
          <% else %>
            <%= render Ui::EmptyStateComponent.new(
              title: "No content", 
              description: "This document doesn't have any content yet.",
              icon: "file"
            ) %>
          <% end %>
        </div>
      </div>

      <!-- Tags Section -->
      <div class="Box mb-4">
        <div class="Box-header d-flex flex-items-center flex-justify-between">
          <h3 class="Box-title">Tags</h3>
          <%= render Primer::Beta::Button.new(
            size: :small,
            scheme: :secondary,
            "data-action": "click->modal#show",
            "data-target": "add-tag-modal"
          ) do %>
            <%= render Primer::Beta::Octicon.new(icon: "plus", size: :small, classes: "mr-1") %>
            Add Tag
          <% end %>
        </div>
        <div class="Box-body">
          <% if @document.tags.any? %>
            <div class="d-flex flex-wrap gap-2">
              <% @document.tags.each do |tag| %>
                <%= render Models::Tags::TagItemComponent.new(tag: tag, removable: true, document: @document) %>
              <% end %>
            </div>
          <% else %>
            <%= render Ui::EmptyStateComponent.new(
              title: "No tags",
              description: "Add tags to help organize and categorize this document.",
              icon: "tag"
            ) %>
          <% end %>
        </div>
      </div>

      <!-- Activity Timeline -->
      <div class="Box">
        <div class="Box-header">
          <h3 class="Box-title">Activity Timeline</h3>
        </div>
        <div class="Box-body">
          <% if @activities.any? %>
            <%= render Models::Activities::TimelineComponent.new(activities: @activities) %>
          <% else %>
            <%= render Ui::EmptyStateComponent.new(
              title: "No activity",
              description: "No activity has been recorded for this document yet.",
              icon: "clock"
            ) %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="Layout-sidebar">
      <!-- Document Actions -->
      <div class="Box mb-4">
        <div class="Box-header">
          <h3 class="Box-title">Actions</h3>
        </div>
        <div class="Box-body">
          <%= render Layout::Card::ActionsMenuComponent.new(resource: @document, resource_type: 'document') %>
        </div>
      </div>

      <!-- Document Details -->
      <div class="Box mb-4">
        <div class="Box-header">
          <h3 class="Box-title">Details</h3>
        </div>
        <div class="Box-body">
          <%= render Models::Documents::MetadataComponent.new(document: @document, layout: :vertical) %>
        </div>
      </div>

      <!-- Related Documents -->
      <div class="Box">
        <div class="Box-header">
          <h3 class="Box-title">Related Documents</h3>
        </div>
        <div class="Box-body">
          <% if @document.folder.present? %>
            <% related_docs = @document.folder.documents.where.not(id: @document.id).limit(5) %>
            <% if related_docs.any? %>
              <div class="d-flex flex-column" style="gap: 12px;">
                <% related_docs.each do |doc| %>
                  <div class="d-flex flex-items-center flex-justify-between">
                    <div class="flex-1 mr-2">
                      <h4 class="f5 mb-1">
                        <%= link_to doc.title, models_document_path(doc), class: "Link--primary" %>
                      </h4>
                      <div class="d-flex flex-items-center gap-2">
                        <%= render Ui::StatusBadgeComponent.new(status: doc.status) if doc.status %>
                        <span class="f6 color-fg-muted">
                          <%= time_ago_in_words(doc.updated_at) %> ago
                        </span>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <p class="f6 color-fg-muted mb-0">No other documents in this folder.</p>
            <% end %>
          <% else %>
            <p class="f6 color-fg-muted mb-0">Document is not in a folder.</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- Add Tag Modal -->
<div class="Overlay Overlay--hidden" id="add-tag-modal">
  <div class="Overlay-backdrop"></div>
  <div class="Overlay-body Overlay-body--small">
    <div class="Box">
      <div class="Box-header">
        <h3 class="Box-title">Add Tag</h3>
        <%= render Primer::Beta::Button.new(
          size: :small,
          scheme: :invisible,
          "data-action": "click->modal#hide",
          classes: "position-absolute top-0 right-0 mt-2 mr-2"
        ) do %>
          <%= render Primer::Beta::Octicon.new(icon: "x") %>
        <% end %>
      </div>
      <%= form_with url: models_add_tag_path(@document), method: :post, local: true do |form| %>
        <div class="Box-body">
          <%= render Primer::Alpha::FormControl.new(label: "Select Tag") do |fc| %>
            <%= fc.select(
              :tag_id,
              options_from_collection_for_select(Tag.all, :id, :name),
              include_blank: "Choose a tag",
              required: true
            ) %>
          <% end %>
        </div>
        <div class="Box-footer d-flex gap-2">
          <%= render Primer::Beta::Button.new(type: :submit, scheme: :primary) do %>
            Add Tag
          <% end %>
          <%= render Primer::Beta::Button.new("data-action": "click->modal#hide") do %>
            Cancel
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
